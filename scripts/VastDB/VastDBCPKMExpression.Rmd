---
title: "VastDBExpressionAnalysis"
author: "Michael K. Jones"
date: "2025-05-14"
output: html_document
---

# VastDB Exploration of Intron Retention Part 2

## Determine relationship of PSI and cRPKM in each cluster

```{r}

library(ggplot2)
library(data.table)

expressionTable <- fread("data/EXPRESSION_TABLE-hg38.tab")
psiTable <- fread("data/PSI_TABLE-hg38.tab")
```

```{r}
# Create table containing only IR events, merge with summary statistics for exploration
psiHsaIN <- psiTable[grep("^HsaIN", psiTable$EVENT), ]
rownames(psiHsaIN) <- psiHsaIN$EVENT
rn <- rownames(psiHsaIN)

# Remove Meta data and Quality measures (-Q$)
metaPsi <- psiHsaIN[, !grepl("-Q$", colnames(psiHsaIN)), with = FALSE]
rownames(metaPsi) <- metaPsi$EVENT

# Create cleaned version of expressionTable
expressionClean <- expressionTable[, !("ID"), with = FALSE]
expressionClean <- expressionClean[, !grepl("-Counts$", colnames(expressionClean)), with = FALSE]
setnames(expressionClean, "NAME", "GENE")

# Add _PSI to PSI columns
psiColsToRename <- colnames(metaPsi)[7:151]
setnames(metaPsi, psiColsToRename, paste0(psiColsToRename, "_PSI"))

# Identify rows where every value is NA and remove those rows for both meta and values Psi tables
all_na_rows <- apply(metaPsi[, 7:151], 1, function(x) all(is.na(x)))
metaPsi <- metaPsi[!all_na_rows, ]

# Convert to matrix and preserve rownames
meta_cols <- c("EVENT", "COORD", "LENGTH", "FullCO", "COMPLEX")  # GENE retained
cleanPsi <- metaPsi[, !colnames(metaPsi) %in% meta_cols, with = FALSE]
valuesPsi <- as.matrix(cleanPsi[, !("GENE"), with = FALSE])
rownames(valuesPsi) <- metaPsi$EVENT

valuesMatrix <- as.matrix(valuesPsi)
rownames(valuesMatrix) <- rownames(metaPsi)
```

```{r}
# Filter rows with >80% NAs
rowNAfraction <- rowMeans(is.na(valuesMatrix))
filteredMatrix <- valuesMatrix[rowNAfraction < 0.8, ]
rownames(filteredMatrix) <- rownames(valuesMatrix)[rowNAfraction < 0.8]

# Impute NAs using row medians
imputeMatrix <- filteredMatrix
for (i in 1:nrow(imputeMatrix)) {
  row_na <- is.na(imputeMatrix[i, ])
  if (any(row_na)) {
    imputeMatrix[i, row_na] <- median(imputeMatrix[i, ], na.rm = TRUE)
  }
}
```

```{r}
# K-means clustering (k = 4) on imputed matrix
set.seed(43)
kmeansRes <- kmeans(imputeMatrix, centers = 4)
clusterLabels <- data.frame(cluster = factor(paste0("Cluster_", kmeansRes$cluster),
                                             levels = paste0("Cluster_", 1:4)))
rownames(clusterLabels) <- rownames(imputeMatrix)

# Order matrix rows by cluster
orderedRows <- rownames(clusterLabels)[order(clusterLabels$cluster)]
matrixOrdered <- filteredMatrix[orderedRows, ]
rowAnnotOrdered <- clusterLabels[orderedRows, , drop = FALSE]

# Add cluster labels back to cleanPsi from imputed dataset
cleanPsiWithClusters <- cleanPsi[rownames(cleanPsi) %in% rownames(clusterLabels)]
cleanPsiWithClusters$CLUSTER <- clusterLabels[rownames(cleanPsiWithClusters), "cluster"]
cleanPsiWithClusters <- cleanPsiWithClusters[!is.na(cleanPsiWithClusters$CLUSTER), ]
```

```{r}
# Recreate colPairs to identify matched tissues
psiCols <- grep("_PSI$", colnames(cleanPsiWithClusters), value = TRUE)
exprCols <- grep("-cRPKM$", colnames(expressionClean), value = TRUE)

psiTissueNames <- sub("_PSI$", "", psiCols)
exprTissueNames <- sub("-cRPKM$", "", exprCols)
matchedTissues <- intersect(psiTissueNames, exprTissueNames)

# Merge expression data into clustered PSI table
mergedClusteredData <- merge(cleanPsiWithClusters, expressionClean, by = "GENE", all.x = TRUE)

# Load and align sample group annotations
sampleGroups <- fread("data/vastdb_Sample_Groups.csv")
sampleGroups <- as.data.frame(sampleGroups)
rownames(sampleGroups) <- sampleGroups$Sample

# Identify matched tissues for plotting
psiCols <- grep("_PSI$", colnames(mergedClusteredData), value = TRUE)
exprCols <- grep("-cRPKM$", colnames(mergedClusteredData), value = TRUE)

psiTissueNames <- sub("_PSI$", "", psiCols)
exprTissueNames <- sub("-cRPKM$", "", exprCols)
matchedTissues <- intersect(psiTissueNames, exprTissueNames)
```

```{r}
# Get tissues in the "Brain" group
brainSamples <- rownames(sampleGroups)[sampleGroups$sample_group == "Brain"]

# Filter matched tissues to only those in the "Brain" group
brainMatched <- intersect(brainSamples, matchedTissues)

# Assemble long-format plotting data for brain tissues
plotList <- lapply(brainMatched, function(tissue) {
  psi_col <- paste0(tissue, "_PSI")
  expr_col <- paste0(tissue, "-cRPKM")
  dt <- mergedClusteredData[, .(Tissue = tissue,
                                PSI = get(psi_col),
                                cRPKM = get(expr_col),
                                CLUSTER)]
  return(dt)
})

plotDataBrain <- rbindlist(plotList)
plotDataBrain <- subset(plotDataBrain, PSI > 0 & PSI < 100 & cRPKM > 0)

# Filter for Cluster 1 only
plotDataBrain_C1 <- plotDataBrain[plotDataBrain$CLUSTER == "Cluster_1", ]
plotDataBrain_C2 <- plotDataBrain[plotDataBrain$CLUSTER == "Cluster_2", ]
plotDataBrain_C3 <- plotDataBrain[plotDataBrain$CLUSTER == "Cluster_3", ]
plotDataBrain_C4 <- plotDataBrain[plotDataBrain$CLUSTER == "Cluster_4", ]
```

```{r}
# Plot PSI vs cRPKM faceted by Tissue
ggplot(plotDataBrain_C3, aes(x = cRPKM, y = PSI)) +
  geom_point(alpha = 0.6, size = 1.2, colour = "#1f77b4") +
  geom_smooth(method = "lm", se = FALSE, linewidth = 0.8, colour = "#1f77b4") +
  facet_wrap(~ Tissue, scales = "free") +
  theme_minimal() +
  labs(title = "PSI vs cRPKM in Brain Tissues (Cluster 3)",
       x = "Expression (cRPKM, log scale)",
       y = "PSI") +
  scale_x_log10() +
  theme(strip.text = element_text(size = 9),
        panel.grid.minor = element_blank())
```

```{r}
# Get tissues in the "Blood" group
bloodSamples <- rownames(sampleGroups)[sampleGroups$sample_group == "Blood"]

# Filter matched tissues to only those in the "Blood" group
bloodMatched <- intersect(bloodSamples, matchedTissues)

# Assemble long-format plotting data for blood tissues
plotListBlood <- lapply(bloodMatched, function(tissue) {
  psi_col <- paste0(tissue, "_PSI")
  expr_col <- paste0(tissue, "-cRPKM")
  dt <- mergedClusteredData[, .(Tissue = tissue,
                                PSI = get(psi_col),
                                cRPKM = get(expr_col),
                                CLUSTER)]
  return(dt)
})

plotDataBlood <- rbindlist(plotListBlood)
plotDataBlood <- subset(plotDataBlood, PSI > 0 & PSI < 100 & cRPKM > 0)

# Plot PSI vs cRPKM for all clusters, faceted by Tissue
ggplot(plotDataBlood, aes(x = cRPKM, y = PSI, colour = CLUSTER)) +
  geom_point(alpha = 0.5, size = 1.2) +
  geom_smooth(method = "lm", se = FALSE, linewidth = 0.7) +
  facet_wrap(~ Tissue, scales = "free") +
  theme_minimal() +
  labs(title = "PSI vs cRPKM in Blood Tissues (All Clusters)",
       x = "Expression (cRPKM, log scale)",
       y = "PSI") +
  scale_x_log10() +
  theme(strip.text = element_text(size = 9),
        panel.grid.minor = element_blank())
```

```{r}

# Prepare long-format data for all matched tissues
plotListAll <- lapply(matchedTissues, function(tissue) {
  psi_col <- paste0(tissue, "_PSI")
  expr_col <- paste0(tissue, "-cRPKM")
  dt <- mergedClusteredData[, .(Tissue = tissue,
                                PSI = get(psi_col),
                                cRPKM = get(expr_col),
                                CLUSTER)]
  return(dt)
})

plotDataAll <- rbindlist(plotListAll)
plotDataAll <- subset(plotDataAll, PSI > 0 & PSI < 100 & cRPKM > 0)

# Annotate with tissue group
plotDataAll$Group <- sampleGroups[plotDataAll$Tissue, "sample_group"]

# Load necessary libraries
library(ggplot2)
library(hexbin)
library(viridis)

# Define hexbin plotting function with saving
plot_cluster_hexbin <- function(cluster_id, bins = 30) {
  
  # Subset data for a specific cluster
  cluster_data <- plotDataAll[CLUSTER == paste0("Cluster_", cluster_id), ]
  
  # Annotate tissue group
  cluster_data$Group <- sampleGroups[cluster_data$Tissue, "sample_group"]
  
  # Create plot
  p <- ggplot(cluster_data, aes(x = cRPKM, y = PSI)) +
    geom_hex(bins = bins) +
    scale_fill_viridis_c(option = "plasma", trans = "log10", name = "Density") +
    facet_wrap(~ Group, scales = "free") +
    scale_x_log10() +
    labs(title = paste("PSI vs cRPKM Across Tissue Groups â€“", paste("Cluster", cluster_id)),
         x = "Expression (cRPKM, log scale)",
         y = "PSI") +
    theme_minimal() +
    theme(strip.text = element_text(size = 9),
          panel.grid.minor = element_blank())
  
  # Save plot
  ggsave(
    filename = paste0("cluster_", cluster_id, "_hexbin_plot.png"),
    plot = p,
    width = 1600 / 150, height = 1200 / 150, dpi = 150, units = "in"
  )
}

# Generate and save plots for all clusters
for (k in 1:4) {
  plot_cluster_hexbin(k)
}

```

```{r}

# Annotate cluster and sample group
plotDataAll$Group <- sampleGroups[plotDataAll$Tissue, "sample_group"]

# Faceted hexbin plot by cluster across all tissues
ggplot(plotDataAll, aes(x = cRPKM, y = PSI)) +
  geom_hex(bins = 30) +
  scale_fill_viridis_c(option = "plasma", trans = "log10", name = "Density") +
  facet_wrap(~ CLUSTER, scales = "free") +
  scale_x_log10() +
  labs(title = "PSI vs cRPKM Across All Tissues by Cluster",
       x = "Expression (cRPKM, log scale)",
       y = "PSI") +
  theme_minimal() +
  theme(strip.text = element_text(size = 10),
        panel.grid.minor = element_blank())

```